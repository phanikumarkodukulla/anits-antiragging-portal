<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body class="admin-page">
    
    <%- include('../partials/admin-navbar', { currentPage: 'sos' }) %>

    <div class="container-fluid px-4 py-4">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h1 class="h2">SOS Emergency Alerts</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="location.reload()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
              </button>
            </div>
          </div>

          <!-- Statistics Cards -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card text-white bg-danger">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title mb-0">New Alerts</h6>
                      <h3 class="mb-0"><%= sosAlerts.filter(a => a.status === 'New').length %></h3>
                    </div>
                    <i class="fas fa-exclamation-circle fa-3x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-warning">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title mb-0">Acknowledged</h6>
                      <h3 class="mb-0"><%= sosAlerts.filter(a => a.status === 'Acknowledged').length %></h3>
                    </div>
                    <i class="fas fa-check-circle fa-3x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-success">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title mb-0">Resolved</h6>
                      <h3 class="mb-0"><%= sosAlerts.filter(a => a.status === 'Resolved').length %></h3>
                    </div>
                    <i class="fas fa-check-double fa-3x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-info">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="card-title mb-0">Total Today</h6>
                      <h3 class="mb-0"><%= sosAlerts.filter(a => new Date(a.timestamp).toDateString() === new Date().toDateString()).length %></h3>
                    </div>
                    <i class="fas fa-calendar-day fa-3x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filter Bar -->
          <div class="card mb-3">
            <div class="card-body">
              <form action="/admin/sos-alerts" method="GET" class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Filter by Status</label>
                  <select class="form-select" name="status" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    <option value="New">New</option>
                    <option value="Acknowledged">Acknowledged</option>
                    <option value="Resolved">Resolved</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Search by Alert ID</label>
                  <input type="text" class="form-control" name="search" placeholder="Enter Alert ID">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-filter me-1"></i>Filter
                  </button>
                  <a href="/admin/sos-alerts" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i>Clear
                  </a>
                </div>
              </form>
            </div>
          </div>

          <!-- SOS Alerts Table -->
          <div class="card shadow-sm">
            <div
              class="card-header bg-danger text-white d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">
                <i class="fas fa-bell me-2"></i>SOS Alerts (<%= sosAlerts.length
                %>)
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Alert ID</th>
                      <th>Location</th>
                      <th>IP Address</th>
                      <th>Status</th>
                      <th>Time</th>
                      <th>Notes</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (sosAlerts.length === 0) { %>
                    <tr>
                      <td colspan="7" class="text-center text-muted py-4">
                        <i
                          class="fas fa-check-circle fa-3x mb-3 d-block text-success"
                        ></i>
                        No SOS alerts found
                      </td>
                    </tr>
                    <% } else { %> <% sosAlerts.forEach(alert => { %>
                    <tr
                      class="<%= alert.status === 'New' ? 'table-danger' : (alert.status === 'Acknowledged' ? 'table-warning' : '') %>"
                    >
                      <td><code><%= alert.alertId %></code></td>
                      <td><%= alert.location %></td>
                      <td><code><%= alert.ipAddress || 'N/A' %></code></td>
                      <td>
                        <% if (alert.status === 'New') { %>
                        <span class="badge bg-danger">New</span>
                        <% } else if (alert.status === 'Acknowledged') { %>
                        <span class="badge bg-warning text-dark"
                          >Acknowledged</span
                        >
                        <% } else { %>
                        <span class="badge bg-success">Resolved</span>
                        <% } %>
                      </td>
                      <td><%= new Date(alert.timestamp).toLocaleString() %></td>
                      <td><%= alert.notes || '-' %></td>
                      <td>
                        <div class="btn-group" role="group">
                          <% if (alert.status === 'New') { %>
                          <button
                            onclick="if(confirm('Acknowledge this SOS alert?')) { document.getElementById('ack-<%= alert._id %>').submit(); }"
                            class="btn btn-sm btn-warning"
                            title="Acknowledge"
                          >
                            <i class="fas fa-bell"></i>
                          </button>
                          <form
                            id="ack-<%= alert._id %>"
                            action="/admin/sos-alerts/<%= alert._id %>/acknowledge"
                            method="POST"
                            class="d-none"
                          ></form>
                          <% } %>
                          
                          <% if (alert.status !== 'Resolved') { %>
                          <button
                            onclick="if(confirm('Mark this SOS alert as resolved?')) { document.getElementById('resolve-<%= alert._id %>').submit(); }"
                            class="btn btn-sm btn-success"
                            title="Mark as Resolved"
                          >
                            <i class="fas fa-check"></i>
                          </button>
                          <form
                            id="resolve-<%= alert._id %>"
                            action="/admin/sos-alerts/<%= alert._id %>/resolve"
                            method="POST"
                            class="d-none"
                          ></form>
                          <% } %>
                          
                          <button
                            type="button"
                            class="btn btn-sm btn-info"
                            data-bs-toggle="modal"
                            data-bs-target="#notesModal-<%= alert._id %>"
                            title="Add Notes"
                          >
                            <i class="fas fa-sticky-note"></i>
                          </button>
                          
                          <button
                            onclick="if(confirm('Delete this alert?')) { document.getElementById('delete-<%= alert._id %>').submit(); }"
                            class="btn btn-sm btn-danger"
                            title="Delete"
                          >
                            <i class="fas fa-trash"></i>
                          </button>
                          <form
                            id="delete-<%= alert._id %>"
                            action="/admin/sos-alerts/<%= alert._id %>/delete"
                            method="POST"
                            class="d-none"
                          ></form>
                        </div>
                      </td>
                    </tr>
                    <% }) %> <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modals Section (outside table) -->
    <% if (sosAlerts.length > 0) { %>
      <% sosAlerts.forEach(alert => { %>
        <div class="modal fade" id="notesModal-<%= alert._id %>" tabindex="-1" aria-labelledby="notesModalLabel-<%= alert._id %>" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="notesModalLabel-<%= alert._id %>">Add Notes to Alert <%= alert.alertId %></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form action="/admin/sos-alerts/<%= alert._id %>/update" method="POST">
                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                      <option value="New" <%= alert.status === 'New' ? 'selected' : '' %>>New</option>
                      <option value="Acknowledged" <%= alert.status === 'Acknowledged' ? 'selected' : '' %>>Acknowledged</option>
                      <option value="Resolved" <%= alert.status === 'Resolved' ? 'selected' : '' %>>Resolved</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" name="notes" rows="4" placeholder="Add notes about this alert..."><%= alert.notes || '' %></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      <% }) %>
    <% } %>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
